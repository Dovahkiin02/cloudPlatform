<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Deployment Dashboard</title>
    <style>
      :root {
        --bg: #0b1220;
        --panel: rgba(255, 255, 255, 0.06);
        --panel2: rgba(255, 255, 255, 0.08);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.65);
        --border: rgba(255, 255, 255, 0.14);
        --ok: #2dd4bf;
        --warn: #fbbf24;
        --bad: #fb7185;
        --btn: rgba(255, 255, 255, 0.12);
        --btn2: rgba(255, 255, 255, 0.18);
        --shadow: 0 12px 40px rgba(0, 0, 0, 0.45);
        --radius: 18px;
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
        --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: var(--sans);
        color: var(--text);
        background:
          radial-gradient(1200px 700px at 20% 0%, rgba(45, 212, 191, 0.20), transparent 60%),
          radial-gradient(900px 600px at 80% 10%, rgba(59, 130, 246, 0.20), transparent 60%),
          radial-gradient(1100px 800px at 50% 100%, rgba(251, 113, 133, 0.15), transparent 60%),
          var(--bg);
        min-height: 100vh;
      }
      .wrap { max-width: 1080px; margin: 0 auto; padding: 32px 16px 64px; }
      header { display: flex; justify-content: space-between; align-items: flex-start; gap: 14px; }
      h1 { margin: 0; font-size: 28px; letter-spacing: 0.2px; }
      .sub { color: var(--muted); margin-top: 6px; line-height: 1.35; max-width: 62ch; }
      .pill {
        display: inline-flex; align-items: center; gap: 8px;
        padding: 8px 10px; border: 1px solid var(--border); border-radius: 999px;
        background: rgba(255,255,255,0.05);
        font-size: 12px; color: var(--muted);
      }
      .grid { display: grid; gap: 14px; margin-top: 18px; }
      .grid.cols { grid-template-columns: repeat(12, 1fr); }
      .card {
        border: 1px solid var(--border);
        background: var(--panel);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
      }
      .card .hd { padding: 14px 16px; background: rgba(255,255,255,0.04); border-bottom: 1px solid var(--border); display:flex; justify-content:space-between; align-items:center; gap:10px; }
      .card .bd { padding: 14px 16px; }
      .title { font-weight: 650; letter-spacing: 0.2px; }
      .muted { color: var(--muted); font-size: 13px; }
      .mono { font-family: var(--mono); }
      .row { display:flex; align-items:center; justify-content:space-between; gap:12px; }
      .row + .row { margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.08); }
      .tag {
        display:inline-flex; align-items:center; gap:8px;
        padding: 6px 10px; border-radius: 999px;
        border: 1px solid rgba(255,255,255,0.14);
        background: rgba(255,255,255,0.06);
        font-size: 12px; color: var(--muted);
      }
      .dot { width: 8px; height: 8px; border-radius: 999px; background: var(--muted); }
      .dot.ok { background: var(--ok); }
      .dot.warn { background: var(--warn); }
      .dot.bad { background: var(--bad); }
      .btn {
        cursor:pointer;
        border: 1px solid rgba(255,255,255,0.14);
        background: var(--btn);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 12px;
        font-weight: 600;
      }
      .btn:hover { background: var(--btn2); }
      .btn:disabled { opacity: 0.55; cursor:not-allowed; }
      .btn.small { padding: 7px 10px; font-size: 12px; border-radius: 10px; }
      .btn.primary { background: rgba(45,212,191,0.14); border-color: rgba(45,212,191,0.28); }
      .btn.primary:hover { background: rgba(45,212,191,0.20); }
      .btn.ghost { background: transparent; }
      input, select {
        width: 100%;
        border: 1px solid rgba(255,255,255,0.16);
        background: rgba(0,0,0,0.18);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 12px;
        outline: none;
      }
      input::placeholder { color: rgba(255,255,255,0.45); }
      .controls { display:grid; grid-template-columns: 1fr 220px; gap:10px; margin-top:10px; }
      .controls2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
      .split { display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
      @media (max-width: 860px) {
        header { flex-direction: column; }
        .split { grid-template-columns: 1fr; }
        .controls { grid-template-columns: 1fr; }
      }
      a { color: rgba(147,197,253,0.95); text-decoration: none; }
      a:hover { text-decoration: underline; }
      .log { max-height: 260px; overflow:auto; padding-right: 6px; }
      .logItem {
        padding: 10px 12px;
        border-radius: 14px;
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.10);
      }
      .logItem + .logItem { margin-top: 10px; }
      .tiny { font-size: 12px; color: var(--muted); }
      .right { text-align:right; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div>
          <h1>Deployment Dashboard</h1>
          <div class="sub">
            Select an application, environment, and a Git commit. The backend moves the corresponding
            <span class="mono">release/*</span> branch to that commit and triggers a Cloudflare Pages deployment.
          </div>
        </div>
        <div class="pill">
          <span class="dot ok"></span>
          Auth via Cloudflare Zero Trust (OTP)
        </div>
      </header>

      <div class="grid split">
        <div class="card">
          <div class="hd">
            <div class="title">Apps</div>
            <button class="btn small" id="refreshAllBtn">Refresh all</button>
          </div>
          <div class="bd" id="apps"></div>
        </div>

        <div class="card">
          <div class="hd">
            <div class="title">Activity</div>
            <div class="row" style="gap:8px;">
              <button class="btn small ghost" id="clearLogBtn">Clear</button>
            </div>
          </div>
          <div class="bd">
            <div class="log" id="log"></div>
          </div>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <div class="hd">
            <div class="title">Deploy</div>
            <div class="muted">Pick commit from list or paste SHA. Deploy triggers branch update + Pages deploy hook.</div>
          </div>
          <div class="bd">
            <div class="controls2">
              <select id="appSelect">
                <option value="app-a">app-a</option>
                <option value="app-b">app-b</option>
              </select>

              <select id="envSelect">
                <option value="dev">dev (release/dev)</option>
                <option value="prod">prod (release/main)</option>
              </select>
            </div>

            <div class="controls">
              <select id="commitSelect">
                <option value="">Loading commits…</option>
              </select>

              <button class="btn primary" id="deployBtn">Deploy selected commit</button>
            </div>

            <div class="controls">
              <input id="commitInput" class="mono" placeholder="or paste commit SHA (7–40 hex chars) …" />
              <button class="btn" id="deployInputBtn">Deploy pasted SHA</button>
            </div>

            <div class="tiny" id="hint" style="margin-top:10px;"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // =========================
      // CONFIG
      // =========================
      const API_BASE = "https://deployment-api.manuel-hanifl.workers.dev"; // <-- your Worker URL

      const APPS = [
        { id: "app-a", name: "app-a", devUrl: "https://cloudplatform-2ok.pages.dev", prodUrl: "https://cloudplatform-2ok.pages.dev" },
        { id: "app-b", name: "app-b", devUrl: "https://app-b.pages.dev", prodUrl: "https://app-b.pages.dev" },
      ];

      const shaRe = /^[0-9a-f]{7,40}$/i;

      // =========================
      // Helpers
      // =========================
      const $ = (id) => document.getElementById(id);
      const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

      function shortSha(sha) {
        return (sha || "").slice(0, 7);
      }

      function statusDot(status, stageStatus) {
        const s = (status || "").toUpperCase();
        const st = (stageStatus || "").toLowerCase();

        // When we deploy we set "PENDING" locally; server status remains OK but stage may be "building"
        if (s === "PENDING" || st === "building" || st === "queued") return "warn";
        if (st === "failure" || st === "failed") return "bad";
        return "ok";
      }

      function fmtTime(iso) {
        if (!iso) return "—";
        const d = new Date(iso);
        return d.toLocaleString();
      }

      function logItem(type, title, details) {
        const el = document.createElement("div");
        el.className = "logItem";
        el.innerHTML = `
          <div class="row">
            <div class="title">${title}</div>
            <div class="tiny mono">${new Date().toLocaleTimeString()}</div>
          </div>
          <div class="tiny" style="margin-top:6px;">${details}</div>
        `;
        const log = $("log");
        log.prepend(el);
      }

      function clearLog() {
        $("log").innerHTML = `<div class="tiny">No activity yet.</div>`;
      }

      async function apiGet(path) {
        const res = await fetch(`${API_BASE}${path}`, { credentials: "include" });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error || `HTTP ${res.status}`);
        return data;
      }

      async function apiPost(path, body) {
        const res = await fetch(`${API_BASE}${path}`, {
          method: "POST",
          credentials: "include",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(body),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok && res.status !== 202) {
          throw new Error(data?.error || `HTTP ${res.status}`);
        }
        return data;
      }

      // =========================
      // State
      // =========================
      const state = {
        status: {
          "app-a": { dev: null, prod: null },
          "app-b": { dev: null, prod: null },
        },
        pending: {
          // pending[app][env] = { commit, since }
          "app-a": { dev: null, prod: null },
          "app-b": { dev: null, prod: null },
        },
        commitsCache: { dev: [], prod: [] },
      };

      // =========================
      // UI render
      // =========================
      function renderApps() {
        const root = $("apps");
        root.innerHTML = "";

        for (const app of APPS) {
          const card = document.createElement("div");
          card.className = "card";
          card.style.boxShadow = "none";
          card.style.background = "rgba(255,255,255,0.04)";
          card.style.borderRadius = "16px";
          card.style.marginBottom = "12px";

          const hd = document.createElement("div");
          hd.className = "hd";
          hd.innerHTML = `
            <div>
              <div class="title">${app.name}</div>
              <div class="muted">Pages project for a deployable static app</div>
            </div>
            <div class="row" style="gap:8px;">
              <a class="btn small ghost" href="${app.prodUrl}" target="_blank" rel="noopener">Visit</a>
              <button class="btn small" data-refresh="${app.id}">Refresh</button>
            </div>
          `;

          const bd = document.createElement("div");
          bd.className = "bd";

          bd.appendChild(renderEnvRow(app.id, "dev", app.devUrl));
          bd.appendChild(renderEnvRow(app.id, "prod", app.prodUrl));

          card.appendChild(hd);
          card.appendChild(bd);
          root.appendChild(card);
        }

        root.querySelectorAll("[data-refresh]").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const appId = btn.getAttribute("data-refresh");
            await refreshOne(appId, "dev");
            await refreshOne(appId, "prod");
            renderApps();
          });
        });
      }

      function renderEnvRow(appId, envName, url) {
        const s = state.status?.[appId]?.[envName];
        const p = state.pending?.[appId]?.[envName];

        const commit = s?.pages?.commit || null;
        const stageStatus = s?.pages?.stageStatus || null;

        // If pending, show pending commit until status catches up
        const shownCommit = p?.commit ? p.commit : commit;
        const dot = statusDot(p ? "PENDING" : (s?.status || "OK"), stageStatus);

        const row = document.createElement("div");
        row.className = "row";
        row.style.alignItems = "flex-start";

        row.innerHTML = `
          <div style="min-width: 0;">
            <div class="row" style="justify-content:flex-start; gap:10px;">
              <span class="tag">
                <span class="dot ${dot}"></span>
                <span class="mono">${envName}</span>
              </span>
              <span class="tag mono">${shownCommit ? shortSha(shownCommit) : "—"}</span>
              ${s?.pages?.deploymentUrl ? `<a class="tag" href="${s.pages.deploymentUrl}" target="_blank" rel="noopener">Deployment</a>` : ``}
            </div>
            <div class="tiny" style="margin-top:8px;">
              URL: <a href="${url}" target="_blank" rel="noopener">${url}</a><br/>
              ${p ? `Pending deploy to <span class="mono">${shortSha(p.commit)}</span>…` : `Last: ${fmtTime(s?.pages?.createdOn)}`}
              ${stageStatus ? ` • stage: <span class="mono">${stageStatus}</span>` : ``}
            </div>
          </div>
          <div class="right tiny">
            ${s?.pages?.message ? `<div title="${s.pages.message.replace(/"/g,'&quot;')}">${s.pages.message.slice(0, 42)}${s.pages.message.length > 42 ? "…" : ""}</div>` : `<div>—</div>`}
          </div>
        `;

        return row;
      }

      // =========================
      // Data loading
      // =========================
      async function refreshOne(appId, envName) {
        try {
          const s = await apiGet(`/status?app=${encodeURIComponent(appId)}&env=${encodeURIComponent(envName)}`);
          state.status[appId][envName] = s;

          // If we were pending, clear it once the deployed commit matches
          const pending = state.pending[appId][envName];
          const deployed = s?.pages?.commit || null;
          if (pending && deployed && shortSha(deployed) === shortSha(pending.commit)) {
            state.pending[appId][envName] = null;
          }
        } catch (e) {
          state.status[appId][envName] = { status: "OK", pages: { error: e.message } };
        }
      }

      async function refreshAll() {
        for (const app of APPS) {
          await refreshOne(app.id, "dev");
          await refreshOne(app.id, "prod");
        }
      }

      async function loadCommits(envName) {
        try {
          const data = await apiGet(`/commits?env=${encodeURIComponent(envName)}&limit=12`);
          state.commitsCache[envName] = data.commits || [];
          return state.commitsCache[envName];
        } catch (e) {
          state.commitsCache[envName] = [];
          return [];
        }
      }

      function renderCommitSelect(envName) {
        const sel = $("commitSelect");
        const commits = state.commitsCache[envName] || [];
        sel.innerHTML = "";

        if (!commits.length) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No commits loaded (check API/auth)";
          sel.appendChild(opt);
          return;
        }

        for (const c of commits) {
          const opt = document.createElement("option");
          opt.value = c.sha;
          opt.textContent = `${c.short} — ${c.message}`;
          sel.appendChild(opt);
        }
      }

      async function deploy(appId, envName, commit) {
        // optimistic pending state
        state.pending[appId][envName] = { commit, since: Date.now() };
        renderApps();

        logItem("deploy", `Deploy ${appId} → ${envName}`, `Requested commit <span class="mono">${shortSha(commit)}</span>`);

        const resp = await apiPost("/deploy", { app: appId, env: envName, commit });

        logItem(
          "deploy",
          `Triggered deployment`,
          `release branch moved + hook called (HTTP ${resp?.trigger?.httpStatus ?? "?"}). Commit: <span class="mono">${shortSha(resp.commit)}</span>`
        );

        // Poll status a few times so the UI “catches up”
        for (let i = 0; i < 10; i++) {
          await sleep(1200);
          await refreshOne(appId, envName);
          renderApps();

          const deployed = state.status?.[appId]?.[envName]?.pages?.commit;
          if (deployed && shortSha(deployed) === shortSha(commit)) break;
        }
      }

      // =========================
      // Init
      // =========================
      function wire() {
        $("refreshAllBtn").addEventListener("click", async () => {
          await refreshAll();
          renderApps();
          logItem("info", "Refreshed", "Refreshed status for all apps/environments.");
        });

        $("clearLogBtn").addEventListener("click", () => {
          clearLog();
          logItem("info", "Activity cleared", "Local activity log was cleared.");
        });

        $("envSelect").addEventListener("change", async () => {
          const envName = $("envSelect").value;
          $("hint").textContent = envName === "dev"
            ? "Dev deploy uses source branch 'dev' and release branch 'release/dev'."
            : "Prod deploy uses source branch 'main' and release branch 'release/main'.";
          await loadCommits(envName);
          renderCommitSelect(envName);
        });

        $("deployBtn").addEventListener("click", async () => {
          const appId = $("appSelect").value;
          const envName = $("envSelect").value;
          const commit = $("commitSelect").value;

          if (!commit) {
            alert("Please select a commit.");
            return;
          }
          try {
            $("deployBtn").disabled = true;
            await deploy(appId, envName, commit);
          } catch (e) {
            state.pending[appId][envName] = null;
            renderApps();
            logItem("error", "Deploy failed", e.message);
            alert(`Deploy failed: ${e.message}`);
          } finally {
            $("deployBtn").disabled = false;
          }
        });

        $("deployInputBtn").addEventListener("click", async () => {
          const appId = $("appSelect").value;
          const envName = $("envSelect").value;
          const commit = ($("commitInput").value || "").trim();

          if (!shaRe.test(commit)) {
            alert("Invalid SHA. Expected 7–40 hex chars.");
            return;
          }

          try {
            $("deployInputBtn").disabled = true;
            await deploy(appId, envName, commit);
          } catch (e) {
            state.pending[appId][envName] = null;
            renderApps();
            logItem("error", "Deploy failed", e.message);
            alert(`Deploy failed: ${e.message}`);
          } finally {
            $("deployInputBtn").disabled = false;
          }
        });
      }

      (async function main() {
        clearLog();

        await refreshAll();
        renderApps();
        wire();

        const envName = $("envSelect").value;
        $("hint").textContent = "Dev deploy uses source branch 'dev' and release branch 'release/dev'.";
        await loadCommits(envName);
        renderCommitSelect(envName);
      })();
    </script>
  </body>
</html>
